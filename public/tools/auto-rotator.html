<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DOGGO MBKS â€” Auto Rotator</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

  :root{
    --bg: #06090f;
    --surface: #0d1117;
    --surface-hover: #161b22;
    --border: #21262d;
    --text: #e6edf3;
    --text-dim: #7d8590;
    --accent: #58a6ff;
    --accent-glow: rgba(88,166,255,0.15);
    --green: #3fb950;
    --red: #f85149;
    --orange: #d29922;
    --radius: 10px;
  }

  html,body{
    height:100%;
    background:var(--bg);
    color:var(--text);
    font-family:'DM Sans',system-ui,sans-serif;
    overflow:hidden;
  }

  .app{
    height:100%;
    display:flex;
    flex-direction:column;
  }

  /* â”€â”€â”€ Top Bar â”€â”€â”€ */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:14px 20px;
    background:var(--surface);
    border-bottom:1px solid var(--border);
    flex-shrink:0;
    gap:16px;
  }

  .topbar-left{
    display:flex;
    align-items:center;
    gap:14px;
  }

  .logo{
    display:flex;align-items:center;gap:8px;
    font-family:'JetBrains Mono',monospace;
    font-weight:600;font-size:0.95rem;
    color:var(--accent);
    letter-spacing:-0.02em;
  }
  .logo-dot{
    width:8px;height:8px;border-radius:50%;
    background:var(--green);
    box-shadow:0 0 8px var(--green);
    animation:pulse-dot 2s ease-in-out infinite;
  }
  @keyframes pulse-dot{
    0%,100%{opacity:1;transform:scale(1)}
    50%{opacity:0.5;transform:scale(0.85)}
  }
  .logo-dot.paused{background:var(--orange);box-shadow:0 0 8px var(--orange);animation:none}

  .badge{
    font-family:'JetBrains Mono',monospace;
    font-size:0.72rem;
    padding:3px 8px;
    border-radius:20px;
    background:var(--accent-glow);
    color:var(--accent);
    border:1px solid rgba(88,166,255,0.2);
  }

  .topbar-right{
    display:flex;align-items:center;gap:10px;
  }

  /* â”€â”€â”€ Mode Tabs â”€â”€â”€ */
  .mode-tabs{
    display:flex;gap:4px;
    background:var(--bg);
    padding:3px;
    border-radius:8px;
    border:1px solid var(--border);
  }
  .mode-tab{
    padding:5px 12px;
    border-radius:6px;
    font-size:0.78rem;
    font-weight:500;
    cursor:pointer;
    transition:all 0.15s;
    border:none;
    background:transparent;
    color:var(--text-dim);
  }
  .mode-tab:hover{color:var(--text)}
  .mode-tab.active{
    background:var(--accent);
    color:#fff;
  }

  /* â”€â”€â”€ Main Content â”€â”€â”€ */
  .main{
    flex:1;
    display:flex;
    overflow:hidden;
  }

  /* â”€â”€â”€ Sidebar â”€â”€â”€ */
  .sidebar{
    width:340px;
    flex-shrink:0;
    background:var(--surface);
    border-right:1px solid var(--border);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .sidebar-header{
    padding:16px;
    border-bottom:1px solid var(--border);
    font-size:0.82rem;
    font-weight:600;
    color:var(--text-dim);
    text-transform:uppercase;
    letter-spacing:0.06em;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }

  .url-list{
    flex:1;
    overflow-y:auto;
    padding:8px;
  }

  .url-item{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:var(--radius);
    cursor:pointer;
    transition:background 0.15s;
    position:relative;
    margin-bottom:2px;
  }
  .url-item:hover{background:var(--surface-hover)}
  .url-item.active{
    background:var(--accent-glow);
    border:1px solid rgba(88,166,255,0.25);
  }
  .url-item.active .url-index{
    background:var(--accent);
    color:#fff;
  }

  .url-index{
    width:24px;height:24px;border-radius:6px;
    display:flex;align-items:center;justify-content:center;
    font-family:'JetBrains Mono',monospace;
    font-size:0.72rem;font-weight:600;
    background:var(--surface-hover);
    color:var(--text-dim);
    flex-shrink:0;
  }

  .url-details{
    flex:1;
    min-width:0;
  }
  .url-name{
    font-size:0.85rem;
    font-weight:500;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    color:var(--text);
  }
  .url-path{
    font-family:'JetBrains Mono',monospace;
    font-size:0.68rem;
    color:var(--text-dim);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    margin-top:2px;
  }

  .url-type-badge{
    font-family:'JetBrains Mono',monospace;
    font-size:0.62rem;
    padding:2px 5px;
    border-radius:4px;
    flex-shrink:0;
  }
  .url-type-badge.web{background:rgba(88,166,255,0.15);color:var(--accent)}
  .url-type-badge.img{background:rgba(63,185,80,0.15);color:var(--green)}

  .url-remove{
    opacity:0;
    background:none;border:none;color:var(--red);
    cursor:pointer;font-size:0.9rem;
    padding:2px 4px;border-radius:4px;
    flex-shrink:0;
    transition:opacity 0.15s;
  }
  .url-item:hover .url-remove{opacity:1}
  .url-remove:hover{background:rgba(248,81,73,0.15)}

  /* â”€â”€â”€ Controls Panel â”€â”€â”€ */
  .controls-panel{
    border-top:1px solid var(--border);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .control-row{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .control-label{
    font-size:0.78rem;
    color:var(--text-dim);
    width:80px;
    flex-shrink:0;
  }

  input[type="number"],select{
    background:var(--bg);
    color:var(--text);
    border:1px solid var(--border);
    padding:7px 10px;
    border-radius:8px;
    font-size:0.85rem;
    font-family:'DM Sans',sans-serif;
    flex:1;
    outline:none;
    transition:border-color 0.15s;
  }
  input[type="number"]:focus,select:focus{
    border-color:var(--accent);
  }

  /* â”€â”€â”€ Transport â”€â”€â”€ */
  .transport{
    display:flex;
    align-items:center;
    gap:6px;
    justify-content:center;
    padding:10px 0;
  }

  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:6px;
    background:var(--surface-hover);
    color:var(--text);
    border:1px solid var(--border);
    padding:8px 14px;
    border-radius:8px;
    font-size:0.85rem;
    font-family:'DM Sans',sans-serif;
    cursor:pointer;
    transition:all 0.15s;
    white-space:nowrap;
  }
  .btn:hover{background:var(--border);border-color:var(--text-dim)}
  .btn:active{transform:scale(0.97)}

  .btn-icon{
    width:38px;height:38px;padding:0;
    font-size:1rem;
  }

  .btn-primary{
    background:var(--accent);
    color:#fff;
    border-color:transparent;
  }
  .btn-primary:hover{
    background:#79c0ff;
    border-color:transparent;
  }

  /* â”€â”€â”€ Toggle â”€â”€â”€ */
  .toggle-wrap{
    display:flex;align-items:center;gap:8px;
  }
  .toggle{
    position:relative;
    width:36px;height:20px;
    appearance:none;-webkit-appearance:none;
    background:var(--border);
    border-radius:20px;
    cursor:pointer;
    transition:background 0.2s;
    outline:none;
    border:none;
    flex-shrink:0;
  }
  .toggle:checked{background:var(--accent)}
  .toggle::before{
    content:'';
    position:absolute;
    top:2px;left:2px;
    width:16px;height:16px;
    border-radius:50%;
    background:#fff;
    transition:transform 0.2s;
  }
  .toggle:checked::before{transform:translateX(16px)}
  .toggle-label{font-size:0.78rem;color:var(--text-dim)}

  /* â”€â”€â”€ Add URL Row â”€â”€â”€ */
  .add-url-row{
    display:flex;gap:6px;
    padding:8px;
    border-top:1px solid var(--border);
  }
  .add-url-row input[type="text"]{
    flex:1;
    background:var(--bg);
    color:var(--text);
    border:1px solid var(--border);
    padding:8px 10px;
    border-radius:8px;
    font-size:0.82rem;
    font-family:'JetBrains Mono',monospace;
    outline:none;
  }
  .add-url-row input[type="text"]:focus{border-color:var(--accent)}
  .add-url-row input[type="text"]::placeholder{color:var(--text-dim)}

  /* â”€â”€â”€ Image drop zone â”€â”€â”€ */
  .drop-zone{
    padding:8px;
    border-top:1px solid var(--border);
  }
  .drop-area{
    border:2px dashed var(--border);
    border-radius:var(--radius);
    padding:14px;
    text-align:center;
    font-size:0.8rem;
    color:var(--text-dim);
    cursor:pointer;
    transition:all 0.15s;
  }
  .drop-area:hover, .drop-area.dragover{
    border-color:var(--accent);
    background:var(--accent-glow);
    color:var(--accent);
  }
  .drop-area input[type="file"]{display:none}

  /* â”€â”€â”€ Status Area â”€â”€â”€ */
  .status-area{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:20px;
    padding:40px;
    position:relative;
    overflow:hidden;
  }

  .status-area::before{
    content:'';
    position:absolute;
    width:500px;height:500px;
    border-radius:50%;
    background:radial-gradient(circle,var(--accent-glow) 0%,transparent 70%);
    opacity:0.4;
    pointer-events:none;
  }

  .status-card{
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:36px 48px;
    text-align:center;
    max-width:560px;
    position:relative;
    z-index:1;
  }

  .status-icon{
    font-size:2.8rem;
    margin-bottom:16px;
  }

  .status-title{
    font-size:1.3rem;
    font-weight:600;
    margin-bottom:8px;
  }

  .status-desc{
    font-size:0.9rem;
    color:var(--text-dim);
    line-height:1.6;
    margin-bottom:24px;
  }

  .status-detail{
    font-family:'JetBrains Mono',monospace;
    font-size:0.75rem;
    color:var(--text-dim);
    background:var(--bg);
    padding:10px 16px;
    border-radius:8px;
    margin-top:12px;
    border:1px solid var(--border);
    word-break:break-all;
  }

  /* â”€â”€â”€ Image Preview â”€â”€â”€ */
  .preview-thumb{
    max-width:100%;
    max-height:200px;
    border-radius:8px;
    margin-top:12px;
    border:1px solid var(--border);
    object-fit:contain;
    display:none;
  }

  /* â”€â”€â”€ Progress bar â”€â”€â”€ */
  .progress-wrap{
    width:100%;
    max-width:400px;
    position:relative;
    z-index:1;
  }
  .progress-bar{
    height:3px;
    background:var(--border);
    border-radius:3px;
    overflow:hidden;
  }
  .progress-fill{
    height:100%;
    background:var(--accent);
    border-radius:3px;
    width:0%;
    transition:width 0.3s linear;
  }
  .progress-text{
    display:flex;
    justify-content:space-between;
    font-size:0.72rem;
    color:var(--text-dim);
    margin-top:6px;
    font-family:'JetBrains Mono',monospace;
  }

  .img-fit-row{display:none}

  /* â”€â”€â”€ Responsive â”€â”€â”€ */
  @media (max-width:768px){
    .sidebar{width:100%;max-height:50%;}
    .main{flex-direction:column}
  }

  ::-webkit-scrollbar{width:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:var(--text-dim)}
</style>
</head>
<body>

<div class="app">

  <!-- Top Bar -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="logo">
        <div class="logo-dot" id="statusDot"></div>
        <span>DOGGO MBKS DASHBOARD</span>
      </div>
      <div class="badge" id="statusBadge">READY</div>
    </div>
    <div class="topbar-right">
      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="window" onclick="setMode('window')">ğŸ–¥ Window</button>
        <button class="mode-tab" data-mode="tab" onclick="setMode('tab')">ğŸ“‘ Tab</button>
      </div>
      <button class="btn" id="btnLaunch" onclick="launchWindow()">
        â–¶ Launch
      </button>
    </div>
  </div>

  <div class="main">

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <span>Rotation Queue</span>
        <span id="urlCount" style="color:var(--accent)">0 items</span>
      </div>

      <div class="url-list" id="urlList"></div>

      <!-- Add URL input -->
      <div class="add-url-row">
        <input type="text" id="newUrlInput" placeholder="Add URL or image URL..." />
        <button class="btn" onclick="addUrl()">+</button>
      </div>

      <!-- Drop zone for local images -->
      <div class="drop-zone">
        <div class="drop-area" id="dropArea">
          ğŸ“ Drop images here or <strong>click to browse</strong>
          <input type="file" id="fileInput" accept="image/*" multiple />
        </div>
      </div>

      <!-- Transport -->
      <div class="controls-panel">
        <div class="transport">
          <button class="btn btn-icon" onclick="goPrev()" title="Previous (â†)">â—€</button>
          <button class="btn btn-icon btn-primary" id="btnPlayPause" onclick="togglePlay()" title="Play/Pause (Space)">â¸</button>
          <button class="btn btn-icon" onclick="goNext()" title="Next (â†’)">â–¶</button>
        </div>

        <div class="control-row">
          <span class="control-label">Interval</span>
          <input type="number" id="intervalInput" min="2" max="600" step="1" value="10" onchange="updateInterval()"/>
          <span style="font-size:0.8rem;color:var(--text-dim)">sec</span>
        </div>

        <div class="control-row img-fit-row" id="imgFitRow">
          <span class="control-label">Image Fit</span>
          <select id="imgFitSelect" onchange="updateImgFit()">
            <option value="contain">Contain (full image)</option>
            <option value="cover">Cover (fill screen)</option>
            <option value="auto">Original size</option>
          </select>
        </div>

        <div class="control-row">
          <span class="control-label">Options</span>
          <div class="toggle-wrap">
            <input type="checkbox" class="toggle" id="chkAutoRelaunch" checked />
            <span class="toggle-label">Auto-relaunch if closed</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Area -->
    <div class="status-area">
      <div class="status-card" id="statusCard">
        <div class="status-icon">ğŸ–¥ï¸</div>
        <div class="status-title" id="statusTitle">Ready to Launch</div>
        <div class="status-desc" id="statusDesc">
          Click <strong>"Launch"</strong> to open a browser window that auto-rotates through your pages and images.<br><br>
          <strong>Web pages</strong> â†’ full browser pages, login &amp; cookies work normally.<br>
          <strong>Images</strong> â†’ displayed fullscreen with dark background.<br><br>
          You can mix URLs and images freely in the same queue.
        </div>
        <div class="status-detail" id="currentUrlDisplay">Waiting...</div>
        <img class="preview-thumb" id="previewThumb" />
      </div>

      <div class="progress-wrap" id="progressWrap" style="display:none">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-text">
          <span id="progressPage">1 / 0</span>
          <span id="progressTime">10s</span>
        </div>
      </div>
    </div>

  </div>
</div>


<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG â€” Your URLs and images here
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const IMAGE_EXTENSIONS = ['jpg','jpeg','png','gif','webp','bmp','svg','avif','tiff'];

const items = [
  // Web pages
  { type: 'web', url: 'https://mbks.doggo.my/DashboardSmartPole' },
  { type: 'web', url: 'https://mbks.doggo.my/DashboardSmartPoleAnalysis/AirAnalytics' },
  { type: 'web', url: 'https://mbks.doggo.my/DashboardSmartPoleAnalysis/SolarAnalytics' },
  { type: 'web', url: 'https://mbks.doggo.my/AlarmLog' },

  // Example images â€” uncomment or add your own:
  // { type: 'img', url: 'https://example.com/photo1.jpg', name: 'Photo 1' },
  // { type: 'img', url: './images/dashboard-screenshot.png', name: 'Screenshot' },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   State
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentIndex = 0;
let playing = true;
let intervalSec = 10;
let imgFit = 'contain';
let timer = null;
let progressTimer = null;
let childWindow = null;
let progressStart = 0;
let launchMode = 'window'; // 'window' or 'tab'

/* DOM refs */
const urlListEl     = document.getElementById('urlList');
const urlCountEl    = document.getElementById('urlCount');
const statusDot     = document.getElementById('statusDot');
const statusBadge   = document.getElementById('statusBadge');
const statusTitle   = document.getElementById('statusTitle');
const statusDesc    = document.getElementById('statusDesc');
const currentUrlEl  = document.getElementById('currentUrlDisplay');
const previewThumb  = document.getElementById('previewThumb');
const progressWrap  = document.getElementById('progressWrap');
const progressFill  = document.getElementById('progressFill');
const progressPage  = document.getElementById('progressPage');
const progressTime  = document.getElementById('progressTime');
const btnPlayPause  = document.getElementById('btnPlayPause');
const btnLaunch     = document.getElementById('btnLaunch');
const intervalInput = document.getElementById('intervalInput');
const chkRelaunch   = document.getElementById('chkAutoRelaunch');
const newUrlInput   = document.getElementById('newUrlInput');
const dropArea      = document.getElementById('dropArea');
const fileInput     = document.getElementById('fileInput');
const imgFitRow     = document.getElementById('imgFitRow');
const imgFitSelect  = document.getElementById('imgFitSelect');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Helpers
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isImageUrl(url) {
  try {
    const ext = url.split('?')[0].split('#')[0].split('.').pop().toLowerCase();
    return IMAGE_EXTENSIONS.includes(ext);
  } catch(e) { return false; }
}

function detectType(url) {
  if (url.startsWith('data:image')) return 'img';
  if (url.startsWith('blob:')) return 'img';
  if (isImageUrl(url)) return 'img';
  return 'web';
}

function getItemName(item) {
  if (item.name) return item.name;
  if (item.type === 'img') {
    try { return item.url.split('/').pop().split('?')[0].substring(0, 40); }
    catch(e) { return 'Image'; }
  }
  try {
    const u = new URL(item.url);
    const path = u.pathname;
    return path === '/' ? u.hostname : path.split('/').filter(Boolean).pop() || path;
  } catch(e) { return item.url.substring(0, 40); }
}

/* Build a fullscreen image viewer page */
function buildImagePage(imgSrc, fit) {
  return `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Image Viewer</title>
<style>
  *{margin:0;padding:0}
  html,body{width:100%;height:100%;background:#0a0a0a;display:flex;align-items:center;justify-content:center;overflow:hidden}
  img{
    ${fit === 'contain' ? 'max-width:100%;max-height:100%;object-fit:contain;' : ''}
    ${fit === 'cover' ? 'width:100%;height:100%;object-fit:cover;' : ''}
    ${fit === 'auto' ? '' : ''}
  }
</style></head>
<body><img src="${imgSrc.replace(/"/g, '&quot;')}" /></body></html>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Render URL list
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderUrlList() {
  urlListEl.innerHTML = '';
  const hasImages = items.some(i => i.type === 'img');
  imgFitRow.style.display = hasImages ? 'flex' : 'none';

  items.forEach((item, i) => {
    const el = document.createElement('div');
    el.className = 'url-item' + (i === currentIndex ? ' active' : '');
    el.onclick = () => goToIndex(i);

    const name = getItemName(item);
    const typeClass = item.type === 'img' ? 'img' : 'web';
    const typeLabel = item.type === 'img' ? 'IMG' : 'WEB';
    const displayUrl = (item.type === 'img' && item.url.startsWith('data:'))
      ? 'data:image/â€¦ (local file)'
      : item.url;

    el.innerHTML = `
      <div class="url-index">${i + 1}</div>
      <div class="url-details">
        <div class="url-name">${name}</div>
        <div class="url-path">${displayUrl}</div>
      </div>
      <div class="url-type-badge ${typeClass}">${typeLabel}</div>
      <button class="url-remove" onclick="event.stopPropagation();removeItem(${i})" title="Remove">âœ•</button>
    `;
    urlListEl.appendChild(el);
  });

  urlCountEl.textContent = items.length + ' item' + (items.length !== 1 ? 's' : '');
}

function removeItem(index) {
  items.splice(index, 1);
  if (currentIndex >= items.length) currentIndex = Math.max(0, items.length - 1);
  renderUrlList();
  updateStatusDisplay();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Mode selection
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setMode(mode) {
  launchMode = mode;
  document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.mode === mode);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Window management
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isWindowOpen() {
  return childWindow && !childWindow.closed;
}

function launchWindow() {
  if (!items.length) return;

  if (isWindowOpen()) {
    childWindow.focus();
    showItem(currentIndex);
    return;
  }

  if (launchMode === 'tab') {
    childWindow = window.open('', '_blank');
  } else {
    childWindow = window.open('', 'doggo_dashboard',
      'width=' + screen.availWidth + ',height=' + screen.availHeight +
      ',left=0,top=0,menubar=no,toolbar=no,location=yes,status=no'
    );
  }

  if (!childWindow) {
    statusTitle.textContent = 'âš ï¸ Popup Blocked';
    statusDesc.textContent = 'Your browser blocked the popup. Please allow popups for this page and try again.';
    return;
  }

  showItem(currentIndex);
  setRunningState();
  startRotation();
}

function showItem(index) {
  if (!items.length) return;
  currentIndex = index;
  const item = items[currentIndex];

  if (!isWindowOpen()) return;

  if (item.type === 'web') {
    // Navigate to URL â€” full browser page, login works
    try {
      childWindow.location.href = item.url;
    } catch(e) {
      childWindow.location.replace(item.url);
    }
  } else {
    // Image: write a fullscreen viewer HTML into the child window
    try {
      childWindow.document.open();
      childWindow.document.write(buildImagePage(item.url, imgFit));
      childWindow.document.close();
    } catch(e) {
      // Fallback: navigate to image URL directly
      try { childWindow.location.href = item.url; } catch(e2) {}
    }
  }

  renderUrlList();
  updateStatusDisplay();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Status visuals
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setRunningState() {
  statusDot.classList.remove('paused');
  statusBadge.textContent = 'RUNNING';
  statusBadge.style.background = 'rgba(63,185,80,0.15)';
  statusBadge.style.color = '#3fb950';
  statusBadge.style.borderColor = 'rgba(63,185,80,0.25)';
  statusTitle.textContent = 'ğŸŸ¢ Window Active';
  statusDesc.innerHTML = 'Rotating through your pages and images.<br>Use the controls on the left to manage playback.';
  btnLaunch.textContent = 'ğŸ”„ Focus';
  progressWrap.style.display = 'block';
  updateStatusDisplay();
}

function setPausedVisual() {
  statusDot.classList.add('paused');
  statusBadge.textContent = 'PAUSED';
  statusBadge.style.background = 'rgba(210,153,34,0.15)';
  statusBadge.style.color = '#d29922';
  statusBadge.style.borderColor = 'rgba(210,153,34,0.25)';
}

function setPlayingVisual() {
  statusDot.classList.remove('paused');
  statusBadge.textContent = 'RUNNING';
  statusBadge.style.background = 'rgba(63,185,80,0.15)';
  statusBadge.style.color = '#3fb950';
  statusBadge.style.borderColor = 'rgba(63,185,80,0.25)';
}

function updateStatusDisplay() {
  if (!items.length) {
    currentUrlEl.textContent = 'No items in queue';
    previewThumb.style.display = 'none';
    return;
  }
  const item = items[currentIndex];
  const display = (item.type === 'img' && item.url.startsWith('data:'))
    ? 'ğŸ“· ' + (item.name || 'Local image')
    : item.url;
  currentUrlEl.textContent = display;
  progressPage.textContent = (currentIndex + 1) + ' / ' + items.length;

  // Show thumbnail preview for images
  if (item.type === 'img') {
    previewThumb.src = item.url;
    previewThumb.style.display = 'block';
  } else {
    previewThumb.style.display = 'none';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Rotation logic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startRotation() {
  stopRotation();
  progressStart = Date.now();

  timer = setInterval(() => {
    if (!playing) return;

    if (!isWindowOpen()) {
      handleWindowClosed();
      return;
    }

    currentIndex = (currentIndex + 1) % items.length;
    showItem(currentIndex);
    progressStart = Date.now();
  }, intervalSec * 1000);

  progressTimer = setInterval(() => {
    if (!playing) return;
    const elapsed = Date.now() - progressStart;
    const pct = Math.min((elapsed / (intervalSec * 1000)) * 100, 100);
    progressFill.style.width = pct + '%';
    const remaining = Math.max(0, Math.ceil((intervalSec * 1000 - elapsed) / 1000));
    progressTime.textContent = remaining + 's';
  }, 200);
}

function stopRotation() {
  if (timer) { clearInterval(timer); timer = null; }
  if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
}

function handleWindowClosed() {
  stopRotation();
  if (chkRelaunch.checked) {
    setTimeout(() => {
      if (!isWindowOpen()) launchWindow();
    }, 2000);
  } else {
    statusTitle.textContent = 'â¹ Window Closed';
    statusDesc.textContent = 'The dashboard window was closed. Click "Launch" to restart.';
    statusBadge.textContent = 'STOPPED';
    statusBadge.style.background = 'rgba(248,81,73,0.15)';
    statusBadge.style.color = '#f85149';
    btnLaunch.textContent = 'â–¶ Launch';
    progressWrap.style.display = 'none';
    previewThumb.style.display = 'none';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Playback controls
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togglePlay() {
  playing = !playing;
  btnPlayPause.textContent = playing ? 'â¸' : 'â–¶';
  if (playing) {
    setPlayingVisual();
    if (isWindowOpen()) {
      progressStart = Date.now();
      startRotation();
    }
  } else {
    setPausedVisual();
    stopRotation();
    progressFill.style.width = '0%';
  }
}

function goNext() {
  if (!items.length) return;
  currentIndex = (currentIndex + 1) % items.length;
  if (isWindowOpen()) showItem(currentIndex);
  else { renderUrlList(); updateStatusDisplay(); }
  if (playing && isWindowOpen()) { progressStart = Date.now(); startRotation(); }
}

function goPrev() {
  if (!items.length) return;
  currentIndex = (currentIndex - 1 + items.length) % items.length;
  if (isWindowOpen()) showItem(currentIndex);
  else { renderUrlList(); updateStatusDisplay(); }
  if (playing && isWindowOpen()) { progressStart = Date.now(); startRotation(); }
}

function goToIndex(i) {
  currentIndex = i;
  if (isWindowOpen()) showItem(currentIndex);
  else { renderUrlList(); updateStatusDisplay(); }
  if (playing && isWindowOpen()) { progressStart = Date.now(); startRotation(); }
}

function updateInterval() {
  intervalSec = parseInt(intervalInput.value, 10) || 10;
  if (playing && isWindowOpen()) { progressStart = Date.now(); startRotation(); }
}

function updateImgFit() {
  imgFit = imgFitSelect.value;
  // Re-render current image if showing
  if (items[currentIndex]?.type === 'img' && isWindowOpen()) {
    showItem(currentIndex);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Add URL / Images
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addUrl() {
  let val = newUrlInput.value.trim();
  if (!val) return;
  if (!val.startsWith('http') && !val.startsWith('data:') && !val.startsWith('blob:') && !val.startsWith('./') && !val.startsWith('/')) {
    val = 'https://' + val;
  }
  const type = detectType(val);
  items.push({ type, url: val, name: '' });
  newUrlInput.value = '';
  renderUrlList();
}

newUrlInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') addUrl();
});

/* â”€â”€â”€ File drop / browse â”€â”€â”€ */
dropArea.addEventListener('click', () => fileInput.click());

dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.classList.add('dragover');
});
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  handleFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', () => {
  handleFiles(fileInput.files);
  fileInput.value = '';
});

function handleFiles(files) {
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      items.push({
        type: 'img',
        url: e.target.result,
        name: file.name
      });
      renderUrlList();
    };
    reader.readAsDataURL(file);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Keyboard shortcuts
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.key === 'ArrowRight') goNext();
  if (e.key === 'ArrowLeft') goPrev();
  if (e.key === ' ' || e.key === 'k') { togglePlay(); e.preventDefault(); }
  if (e.key === 'Enter') launchWindow();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Periodic check if child window closed
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setInterval(() => {
  if (childWindow && childWindow.closed) {
    handleWindowClosed();
    childWindow = null;
  }
}, 1500);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Init
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
renderUrlList();
updateStatusDisplay();
</script>

</body>
</html>
